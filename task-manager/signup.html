<!doctype html>
<html lang="en">

<head>
  <script>
    if(localStorage.getItem('username')) {
      window.location = '/task-manager'
    }
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
  integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.3.0/mdb.min.css" rel="stylesheet" /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <!-- <link rel="stylesheet" href="/cdn/bootstrap-icons.css"> -->
  <link rel="stylesheet" href="/cdn/bootstrap.min.css" /> 
  <link rel="stylesheet" href="/cdn/mdb.min.css" />
 
  <link rel="icon" type="image/png" href="/assets/img/site/logo.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/assets/img/site/logo.png" sizes="16x16" />
  <title>Task Manager</title>
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      align-items: center;
      flex-direction: column;
      /* justify-content: center; */
    }

    #center-item {
      height: calc(100% - var(--navbar-height));
      width: 100%;
      display: flex;
      align-items: center;
    }

    #navbar {
      width: 100%;
    }

    .rohilla:hover {
      color: rgba(0, 255, 255, 0.775) !important;
    }

    .nav-link:hover {
      color: lightseagreen !important;
    }

    .popover {
      background-color: rgb(167, 208, 221);
      border: 2px solid darkcyan;
      width: 98vw;
      max-width: 500px;
      margin-left: auto !important;
      margin-right: auto !important;
      margin-top: 15px;
    }

    .bs-popover-auto[x-placement^=bottom] .arrow::after,
    .bs-popover-bottom .arrow::after {
      top: 1px;
      border-bottom-color: rgb(167, 208, 221);
    }

    #name,
    #email,
    #password {
      background-color: rgb(167, 216, 225);
    }
  </style>

</head>

<body onload="center()" onresize="center()" class="bg-dark">

  <nav class="navbar navbar-expand-sm navbar-dark" id="navbar"
    style="background-color: rgb(21, 21, 21); border-bottom: 1px solid white;">
    <a class="navbar-brand rohilla" href="/" target="_blank" style="color: cyan;">Rohilla</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon">
        <i class="fa-solid fa-bars"></i>
      </span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">

        <li class="nav-item">
          <div class="nav-link" href="/task-manager" style="color: lightcyan;">Task Manager</div>
        </li>
        <li class="nav-item" id="popover-btn">
          <span class="nav-link" style="color: lightcyan; cursor: pointer;" data-mdb-placement="bottom" tabindex="0"
            data-mdb-toggle="popover" data-mdb-container="body" data-html="true" data-toggle="popover"
            id="popover">Docs</span>
        </li>

      </ul>

      <a href="/task-manager" class="ml-auto"><button type="button"
          class="btn btn-outline-success px-2 my-1">Login</button></a>

    </div>
  </nav>

  <div id="popover-content" style="display: none;">

    <h6 style="color: #212529;"><em><strong>API</strong></em></h6>
    <ul class="pl-3" style="color: #212529; font-size: 14px; text-align: justify;">
      <li>Create an account on rohilla.co.in for testing the Task Manager API </li>
      <li>Send a GET request to /task-manager/api/auth/token to get the Bearer type access token by sending your email
        and password as json in request body </li>
      <li>A task has two parameters - name=string and completed=boolean </li>
    </ul>


    <pre class="my-1"><strong style="font-size: 14px;">Base URL : rohilla-co-in.herokuapp.com/task-manager</strong></pre>
    <pre class="mb-0" style="font-size: 14px;">
  POST   /api     - create a task
  GET    /api/:id - get a task by id
  PATCH  /api/:id - update a task by id
  DELETE /api/:id - delete a task by id
  GET    /api     - get all tasks
  DELETE /api     - delete all tasks
  PATCH  /api     - mark/unmark all tasks</pre>

    <div style="border-top: 2px solid rgb(45, 115, 138); margin: 15px -17px;"></div>

    <div class="container d-flex justify-content-between align-items-center">
      <a href="https://github.com/aman-rohilla/Task-Manager" class="btn btn-primary btn-sm" target="_blank"
        style="background-color: rgb(13, 121, 116);">
        <i class="fa-brands fa-github fa-xl mr-1"></i>
        <span>Git Repo</span>
      </a>

      <button type="button" class="btn btn-primary btn-sm" onclick="$('#popover').trigger('click');">
        <i class="fa-solid fa-xmark fa-lg mr-1"></i>
        Close
      </button>
    </div>

  </div>



  <div id="center-item">
  <div class="d-flex justify-content-center" style="width: 100%;">
    <div class="container px-4 py-3 mx-3" style="color: black; width: 400px; border: 3px solid white;
    border-radius: 12px;
    /* background-color: rgb(227, 144, 42); */
    background-color: rgb(102, 155, 166);
    /* box-shadow: 0px 15px 25px lightsalmon; */
    /* box-shadow: 0px 15px 25px rgb(43, 228, 228); */
    box-shadow: 0px 15px 25px rgb(102, 155, 166);
    ">
      <form id="signup-form" class="pt-2 pb-4 align-items-center justify-content-center" onsubmit="event.preventDefault(); signupHandler(this);">

        
        <h3 class="text-center mb-4 pb-4 mx-3" style="color: lightcyan; border-bottom: 2px solid white;">Create New Account</h3>
        
        <div class="alerts"></div>

        <div class="form-floating my-3">
          <input type="text" class="form-control" id="name" name="name" placeholder="Name">
          <label for="name">Name</label>
        </div>
        <div class="form-floating my-3">
          <input type="text" class="form-control" id="email" placeholder="name@example.com" name="email">
          <label for="email">Email</label>
        </div>
        <div class="form-floating my-3">
          <input type="password" class="form-control" id="password" placeholder="Password" name="password">
          <label for="password">Password</label>
        </div>
        
        <div class="justify-content-center mt-4">

          <button id="signup-form-btn" type="submit" class="btn btn-primary btn-sm btn-block d-flex justify-content-start align-items-center" style="height: 40px; background-color: darkcyan;" type="submit">
            <div class="clearfix spinner-div" style="width: 33%;">
              <!-- <span class="d-none float-end spinner spinner-border spinner-border-sm" role="status" aria-hidden="true" style="height: 20px; width: 20px;"></span> -->
            </div>
            <div class="px-0" style="width: 34%; font-size: 14px;">Register</div>
          </button>  

        </div>

      </form>
    </div>
  </div>
  </div>

  <div id="spinner-btn-content" class="d-none">
    <span class="float-end spinner spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true" style="height: 20px; width: 20px;"></span>
  </div>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/5396b23a54.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.3.0/mdb.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
      integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
      crossorigin="anonymous"></script> -->
      
  <script src="/cdn/axios.min.js"></script>
  <script src="/cdn/fontawesome.js"></script>
  <script src="/cdn/jquery-3.3.1.js"></script>
  <script src="/cdn/popper.min.js"></script>
  <script src="/cdn/mdb.min.js"></script>
  <script src="/cdn/bootstrap.min.js"></script>
      
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <script>
    const baseURL = 'https://rohilla-co-in.herokuapp.com'
    axios.defaults.withCredentials = true
  </script>


  <!-- Center script -->
  <script>
    const navbar = document.getElementById('navbar')
    if (navbar) {
      document.documentElement.style.setProperty('--navbar-height', navbar.offsetHeight.toString() + 'px')
    }

    const html = document.querySelector('html')
    const centerItem = document.getElementById('center-item')
    function center() {
      const centerItemHeight = centerItem ? centerItem.scrollHeight : 0
      if (html.scrollHeight > window.innerHeight || centerItemHeight > window.innerHeight)
        html.style.setProperty('height', 'auto')
      else
        html.style.setProperty('height', '100%')
    }
  </script>

  <script>
    const tabID = Math.floor(Math.random() * 1000000);

    const receiver = new BroadcastChannel('tab-communication');
    receiver.addEventListener ('message', (e) => {
      if (e.data.tabID != tabID) {
        setTimeout(() => {

          if(e.data.message == 'LOGIN' || e.data.message == 'SIGNUP') {
            window.location = '/task-manager'
          }
          // if(e.data.message == 'RELOAD') {
          //   window.location.reload()
          // }
          // else if(e.data.message == 'LOGOUT')
          //   window.location = '/task-manager/logout'
        }, e.data.delay)
      }
    });

    const sender = new BroadcastChannel('tab-communication')
    function sendRequest(message = 'RELOAD', delay = 0) {
      sender.postMessage({ tabID, message, delay })
    }

  </script>


  <script>
    $('#popover').popover({
      html: true,
      trigger: 'click',
      placement: 'bottom',
      content: function () { return $('#popover-content').html(); }
    }).on('shown.bs.popover', (event) => {
      $('body').on('click', function (e) {
        $('[data-toggle="popover"]').each(function () {
          if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
            $(this).trigger('click');
          }
        });
      });
    }).on('hidden.bs.popover', (event) => {
      $('body').unbind('click')
    });

  </script>


<script>
const alertDiv = document.querySelector('.alerts')

async function alertMessage(messages, element_id='', margin_bottom='2', margin_top='0', padding='5px', max_width='') {

  if(padding=='') padding = '5px'
  if(margin_bottom=='') margin_bottom = '2'

  const max_width_str = max_width ? `max-width: ${max_width};` : ''
  const arr = Array.isArray(messages) ? messages : [messages]

  if(alertDiv.childElementCount) {

    let count=0
    $(alertDiv).find('.message').each((index, div) => {
      const message = div.innerText
      const category = div.parentElement.parentElement.getAttribute('category')

      if(arr.find(currMsg => currMsg.message == message && currMsg.category == category)) {
        count ++
      }       
    });

    if(count==arr.length && arr.length==alertDiv.childElementCount) {
      await $(alertDiv).children().each((index, div) => $(div).effect('shake', {distance: 7})).promise()
      return
    } else {
      await clearAlerts(alertDiv)
    }
  }

  let alert = ''

  arr.forEach((message) => {
    alert += 
    `<div class="container px-3 mb-${margin_top} mb-${margin_bottom} alert alert-${message.category} alert-dismissible fade show" role="alert" style="padding-top: ${padding}; padding-bottom: ${padding}; ${max_width_str}" category="${message.category}">

    <div class="d-flex justify-content-between align-items-center"> 
    <div class="message">${message.message}</div>
    <button type="button" class="close ml-3" data-dismiss="alert" aria-label="Close" style="position: relative; padding: 7px;" onclick="event.stopPropagation(); hideAlert(this.parentElement.parentElement)">
      <span aria-hidden="true">&times;</span>   
    </button>
    </div>
    </div>`      
  })

  var el = $(alert).hide();
  el.css('opacity', '0')
  $(alertDiv).append(el);
  // el.show(2000);

  $(el).show({duration: 300}, 'linear')
  $(el).animate({opacity: 1}, {duration: 400});
}

async function hideAlert(target) {
  $(target.parentElement).css('height', target.parentElement.scrollHeight)
  const newHeight = target.parentElement.scrollHeight - target.scrollHeight

  // await $(target).hide('slide', {direction: 'down'}, 500).promise();    
  await $(target).hide('slide', {direction: 'right'}, 500).promise();
  await $(target.parentElement).animate({height: newHeight}, {duration: 300}).promise()

  $(target.parentElement).css('height', 'auto')
  $(target).alert('close')
}

async function clearAlerts(alertDiv) {
  if(!alertDiv || !alertDiv.childElementCount) return
  await $(alertDiv).children().each((index, div) => $(div).animate({opacity: 0}, {duration: 300})).promise()
  await $(alertDiv).animate({height: 0}, {duration: 400}).promise()
  alertDiv.innerHTML = ''
  $(alertDiv).css('height', 'auto')
}

async function toggleDivContent(div, content, seconds=400, fade_last_content=false) {
  if(fade_last_content || div.html().includes('<'))
    await $(div).fadeOut(seconds, function() {
      $(this).html(content).fadeIn(seconds, ()=>{})
    }).promise();
  else 
    await $(div).html(content).fadeIn(seconds, ()=>{}).promise()
}


const spinnerBtnContent = $('#spinner-btn-content').html()
function startBtnSpinner(btn, duration=100) {
  btn.prop('disabled', true);
  toggleDivContent($(btn).find('.spinner-div'), spinnerBtnContent, duration)
}

async function stopBtnSpinner(btn, duration=300) {
  await toggleDivContent($(btn).find('.spinner-div'), '', duration)    
  btn.prop('disabled', false);
}


function isEmailValid(email) {
  const matches = email.match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)
  if(matches) return true
  return false
}

</script>


<script>


async function signupHandler(target) {
  const spinnerDiv = $(target).find('button[type=submit]')
  startBtnSpinner(spinnerDiv)

  const nameForm      = document.getElementById('name')
  const emailForm     = document.getElementById('email')
  const passwordForm  = document.getElementById('password')

  const name     = nameForm.value.trim()
  const email    = emailForm.value.trim()
  const password = passwordForm.value.trim()

  if(!email || !password || !name) {
    stopBtnSpinner(spinnerDiv)  
    return await alertMessage({message: 'Some fields are empty', category: 'warning'})
  }

  let messages = []
  if(! isEmailValid(email))
    messages.push({message: 'Email is invalid', category: 'warning'})  

  if(password.length<8) 
    messages.push({message: `Password is less than 8 characters`, category: 'warning'})

  if(messages.length) {
    stopBtnSpinner(spinnerDiv)  
    return await alertMessage(messages)
  }

  try {
    clearAlerts(alertDiv)
    const res = await axios.post(`${baseURL}/api/signup`, { name, email, password})
    await stopBtnSpinner(spinnerDiv)  
    let message = res.data.message
    
    if(res.data.status=='success') message += '... Redirecting'

    if(message) {
      await alertMessage({message, category: res.data.category})
    }
    if(res.data.status=='success') {
      target.reset()
      $(target).find('input').blur()
      await new Promise(resolve => setTimeout(resolve, 2000))
      localStorage.setItem('token', res.data.token)
      localStorage.setItem('username', res.data.username)
      sendRequest('SIGNUP')
      window.location = '/task-manager'
      // await new Promise(resolve => setTimeout(resolve, 1000));
    }

  } catch (error) {
    await stopBtnSpinner(spinnerDiv)  
    await alertMessage({message: 'Something went wrong', category: 'danger'})
  }
}
</script>


</body>

</html>